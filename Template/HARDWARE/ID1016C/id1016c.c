#include "id1016c.h"


u8 register_flag = 0;	//指纹录入标志

/*******************************************指纹模块指令集****************************************************/

//从采集器采集指纹图像并暂存于 ImageBuffer 中
uint8_t CMD_GET_IMAGE[] =       {0x55,0xAA,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                                 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0x01};
//检测指纹输入状态（有/无手指）
uint8_t CMD_FINGER_DETECT[] =   {0x55,0xAA,0x00,0x00,0x21,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	                             0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x01};
//打开背光
uint8_t CMD_Open_Backlight[] =  {0x55,0xaa,0x00,0x00,0x24,0x00,0x02,0x00,0x01,0x00,0x00,0x00,0x00,
                                 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x26,0x01};
//关闭背光
uint8_t CMD_Close_Backlight[] = {0x55,0xAA,0x00,0x00,0x24,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,
                                 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x25,0x01};
//打开红色背光
uint8_t CMD_RED_LED[] =         {0x55,0xAA,0x00,0x00,0x24,0x00,0x04,0x00,0x01,0x02,0x00,0x00,0x00,
	                             0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x2A,0x01};
//打开绿色背光
uint8_t CMD_GREEN_LED[] =       {0x55,0xAA,0x00,0x00,0x24,0x00,0x04,0x00,0x01,0x01,0x04,0x09,0x00,
	                             0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x36,0x01};
//将暂存于指定 Ram Buffer 中的指纹模板保存于指定编号的模块指纹库中
uint8_t CMD_STORE_CHAR[] =      {0x55,0xAA,0x00,0x00,0x40,0x00,0x04,0x00,0x01,0x00,0x00,0x00,0x00,
                                 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x44,0x01};
//删除指纹库中的指定编号范围内的所有指纹模板
uint8_t CMD_DEL_CHAR[] =        {0x55,0xAA,0x00,0x00,0x44,0x00,0x04,0x00,0x01,0x00,0x32,0x00,0x00,
                                 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x02};
//获取指定编号的模板注册状态
uint8_t CMD_GET_STATUS[] =      {0x55,0xAA,0x00,0x00,0x46,0x00,0x02,0x00,0x01,0x00,0x00,0x00,0x00,
                                 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x48,0x01};								 
//从 ImageBuffer 中的指纹图像产生指纹模板 Template 并保存于指定 RamBuffer0 中
uint8_t CMD_GENERATE[] =        {0x55,0xAA,0x00,0x00,0x60,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,
                                 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x61,0x01};
//从 ImageBuffer 中生成模板数据保存在 RamBuffer1 中
uint8_t CMD_62[] =              {0x55,0xAA,0x00,0x00,0x60,0x00,0x02,0x00,0x01,0x00,0x00,0x00,0x00,
	                             0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x62,0x01};
//从 ImageBuffer 中生成模板数据保存在 RamBuffer2 中
uint8_t CMD_63[] =              {0x55,0xAA,0x00,0x00,0x60,0x00,0x02,0x00,0x02,0x00,0x00,0x00,0x00,
	                             0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x63,0x01};
// 将暂存于 Ram Buffer 中的两或三个模板数据融合成一个模板数据
//注： 融合后的模板数据暂存在 RamBuffer 0
uint8_t CMD_MERGE[] =           {0x55,0xAA,0x00,0x00,0x61,0x00,0x03,0x00,0x00,0x00,0x03,0x00,0x00,
                                 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x66,0x01};						 
//指定编号范围内的 1： N 识别
uint8_t CMD_SEARCH[] =          {0x55,0xAA,0x00,0x00,0x63,0x00,0x06,0x00,0x00,0x00,0x01,0x00,0x50,
                                 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x31,0x02};
//指定 Ram Buffer 中的指纹模板与指纹库中指定编号的指纹模板之间进行 1:1 比对（验证）
uint8_t CMD_VERIFY[] =          {0x55,0xAA,0x00,0x00,0x64,0x00,0x04,0x00,0x01,0x00,0x00,0x00,0x00,
                                 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x68,0x01};


void ID1016C_Init(void)
{
	USART6_Init(115200); //初始化串口
	ID1016C_EXTI_Init();	//初始化外部中断
}

/*计算校验和*/
u16 ID1016C_GetVerification(u8 *cmd, u8 len)
{
	u32 lenl, lenh, lensum = 0;
	u8 i;
	
	if(len >= 26)
	{
		for(i = 0; i < 11; i++)
			lenl += cmd[i];
		for(i = 11; i < 24; i++)
			lenh += cmd[i];
		//lensum = (lenl + lenh) % 65536;
		lensum = (lenl + lenh) & 0xffff;
	}
	
	return lensum;
}

/*发送数据到模块*/
void ID1016C_SendData(u8 *cmd, u16 len)
{
	USART6_Send_Length_String(cmd, len);
}

/*指纹录入*/
u8 ID1016C_Register(u16 id_num)
{
	u32 timeout = 5000; //超时时间
	
	register_flag = 1;
	//1.判断注册ID是否存在
	while(1)
	{
		if(register_flag == 1)
		{
			CMD_GET_STATUS[8] = (id_num & 0xff); 
			CMD_GET_STATUS[9] = (id_num >> 8) &0xff;
			ID1016C_SendData(CMD_GET_STATUS, sizeof(CMD_GET_STATUS));
		}
	}
	
	//2.采集指纹图像
	//3.转换成特征模板
	//4.融合指纹模板
	//5.保存指纹模板
}


